---
title: 'Generant autom√†ticament imatges Open Graph a partir de contingut din√†mic'
publishedAt: '2023-10-28'
summary: "Un tutorial sobre com automatitzar la creaci√≥ d'imatges Open Graph per a les publicacions del vostre blog amb Vercel OG."
---

Una imatge Open Graph (OG) √©s la imatge que les xarxes socials (com Twitter o Facebook) extreuen d‚Äôuna web per crear una previsualitzaci√≥ quan alg√∫ comparteix un enlla√ß a aquesta web.

Independentment de l‚Äôefectivitat o la qualitat real del contingut enlla√ßat, una imatge OG sol ser el primer que la gent veu d‚Äôuna publicaci√≥ compartida a les xarxes socials.

En teoria, una millor imatge OG augmenta la freq√º√®ncia amb qu√® la gent fa clic a l‚Äôenlla√ß de la publicaci√≥ i republica la publicaci√≥ original.

<FauxTweet>
  <Image
    alt="Faux Tweet"
    src="https://smartido.dev/api/og?title=Generant%20autom√†ticament%20imatges%20Open%20Graph%20a%20partir%20de%20contingut%20din√†mic&publishedAt=2023-10-28"
    width={779}
    height={620}
  />
</FauxTweet>

Aquest tutorial √©s una guia pas a pas de com podem automatitzar la generaci√≥ d‚Äôimatges OG a partir de continguts din√†mics del nostre blog.

### El problema

- Crear manualment una imatge OG per a cada publicaci√≥ implica feina i temps a part d‚Äôescriure la publicaci√≥.
- Automatitzar la generaci√≥ d‚Äôimatges OG pot ser dif√≠cil d‚Äôimplementar o pot costar diners per l‚Äôutilitzaci√≥ d‚Äôun servei.

### La soluci√≥

Utilitzeu la biblioteca de codi lliure `@vercel/og`. Aquests s√≥n els avantatges:

- **F√†cil d‚Äôutilitzar**: Definiu les vostres imatges amb HTML i CSS, i crea autom√†ticament imatges din√†miques a partir dels SVGs generats. 
- **Assequible**: Afegeix autom√†ticament les cap√ßaleres que toquen a la mem√≤ria cau de l'*edge* (√©s a dir, el m√©s a la vora d‚Äôon √©s generen les imatges), ajudant a reduir el cost i la recomputaci√≥.
- **R√†pid**: Utilitza [Edge Functions](https://vercel.com/docs/functions/edge-functions), afavorint que les imatges es generin m√©s r√†pid i siguin reconegudes pels simuladors (com [Open Graph Debugger](https://en.rakko.tools/tools/9/)).
- **Din√†mic**: Utilitza detalls din√†mics de la publicaci√≥ com el t√≠tol i la data de publicaci√≥ per generar la imatge final.
- **Disseny flexible**: Manipula el disseny, estils i tipografia amb CSS b√†sic.
- **M√∫ltiples opcions de *frameworks***: √âs compatible amb qualsevol *framework* o aplicaci√≥ desplegada a Vercel.
- **M√∫ltiples opcions tipogr√†fiques**: √âs compatible amb l‚Äô√∫s de fonts i emoticones customitzades (incloent Google Fonts i altres CDNs).

### Qu√® √©s Vercel OG?

[Vercel OG](https://vercel.com/docs/functions/edge-functions/og-image-generation) √©s una biblioteca que genera imatges OG de forma din√†mica i optimitzada. Tamb√© proporciona un [playground](https://og-playground.vercel.app/) per testejar i previsualitzar la imatge OG generada. Podeu accedir al seu codi [aqu√≠](https://github.com/vercel/og-image).

Funciona de forma que vosaltres li passeu continguts per par√†metres de la URL, i Vercel OG us genera, c√≤pia a la mem√≤ria cau, i retorna un fitxer d‚Äôimatge.

Per exemple, la imatge de sota es genera amb l'URL seg√ºent:

<Image
  alt="Open Graph image example"
  src="https://smartido.dev/api/og?title=Generant%20autom√†ticament%20imatges%20Open%20Graph%20a%20partir%20de%20contingut%20din√†mic&publishedAt=2023-10-28"
  width={779}
  height={620}
/>

<Callout>
  [https://smartido.dev/api/og?title=Generant%20autom√†ticament%20imatges%20Open%20Graph%20a%20partir%20de%20contingut%20din√†mic&publishedAt=2023-10-28](https://smartido.dev/api/og?title=Generant%20autom√†ticament%20imatges%20Open%20Graph%20a%20partir%20de%20contingut%20din√†mic&publishedAt=2023-10-28)
</Callout>

### Posant fil a l'agulla

<Callout emoji="üí°">
  Aquest tutorial implementa Vercel OG pel directori `app` de Next.js 13. Per implementacions en altres *frameworks*, el codi pot variar lleugerament.
</Callout>

#### Pas 1 ‚Äì Instal¬∑lant la biblioteca Vercel OG

Si utilitzeu App Router podeu saltar-vos aquest pas, ja que inclou `@vercel/og`. Altrament, executeu la seg√ºent comanda dins el directori del vostre projecte:

```code
pnpm i @vercel/og
```

#### Pas 2 ‚Äì Creant l'API endpoint

Creeu un API endpoint afegint un fitxer `route.tsx` al directori `api/og` a l‚Äôarrel del vostre projecte.

A continuaci√≥, enganxeu el codi seg√ºent:

```tsx showLineNumbers title="api/og/route.tsx"
import { ImageResponse } from 'next/server';

export const runtime = 'edge';
 
export async function GET() {
  return new ImageResponse(
    (
      <div
        style={{
          height: '100%',
          width: '100%',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'flex-start',
          justifyContent: 'flex-end',
          backgroundImage: 'url(https://.../og.png)',
        }}
      >
        <div
          style={{
            marginBottom: 150,
            marginLeft: 150,
            marginRight: 150,
            display: 'flex',
            flexDirection: 'column',
            fontSize: 120,
            color: 'white',
          }}
        >
          <h1>My post title</h1>
          <div
            style={{
              display: 'flex',
              fontSize: 60,
            }}
          >
            smartido.dev ¬∑ My post published date
          </div>
        </div>
      </div>
    ),
    {
      width: 1920,
      height: 1080,
    },
  );
}
```

- **L√≠nia 3**: Cal utilitzar l‚Äô[Edge Runtime](https://vercel.com/docs/functions/edge-functions/edge-functions-api), ja que l‚Äôentorn d‚Äôexecuci√≥ per defecte de Node.js no √©s compatible amb `@vercel/og`.
- **L√≠nia 16**: Recordeu carregar la imatge de fons que voleu utilitzar per la imatge OG dins la carpeta `public` del vostre projecte i desplegar-la perqu√® existeixi a la ruta especificada.
- **L√≠nies 6-46**: Crideu el constructor `ImageReponse` passant-li com a par√†metres l‚Äôelement de React i les opcions d‚Äôamplada i al√ßada per generar la vostra imatge. Podeu consultar-los tots a la [documentaci√≥ de l‚ÄôAPI](https://vercel.com/docs/functions/edge-functions/og-image-generation/og-image-api).

Si correu l‚Äôaplicaci√≥ en local, podeu cridar el vostre endpoint des del navegador amb l'URL `http://localhost:3000/api/og`.

Per obtenir una URL p√∫blicament accessible al vostre endpoint desplegueu el projecte.

<Callout emoji="‚ö†Ô∏è">
  **Limitacions**

  Vercel OG limita la mida de l‚Äôempaquetat o *bundle* a un m√†xim de 500KB. Aix√≤ inclou el vostre JSX, CSS, fonts, imatges i la resta d‚Äô*assets*. Si la mida de la vostra imatge de fons √©s molt gran, potser us interessar√† reduir-la.

  Nom√©s s√≥n compatibles flexbox (`display: flex`) i un subconjunt de propietats CSS. Altres layouts (`display: grid`) no funcionaran. Podeu consultar totes les propietats CSS compatibles a la [documentaci√≥ de Satori](https://github.com/vercel/satori).
</Callout>

#### Pas 3 ‚Äì Definint les metadates de l'aplicaci√≥

A continuaci√≥, podeu utilitzar l‚Äô[API Metadata](https://nextjs.org/docs/app/building-your-application/optimizing/metadata) de Next.js per definir les metadades de la vostra aplicaci√≥ (per exemple, les etiquetes `meta` i `link` dins el vostre element HTML `head`). Aquesta API est√† optimitzada per un millor SEO.

```tsx showLineNumbers title="layout.tsx"
import type { Metadata } from 'next';

export async function generateMetadata(): Promise<Metadata> {
  const ogImage = 'https://.../api/og';
  
  return {
    title: 'My post title',
    openGraph: {
      images: [{ url: ogImage }],
    },
  }
}
 
export default function Page() {}
```

Next.js generar√† autom√†ticament els elements `<head>` rellevants per a les vostres p√†gines.

```html title="Output <head>"
<meta property="og:title" content="My post title" />
<meta property="og:image:url" content="https://.../og.png" />
```

#### Pas 4 ‚Äì Passant contingut per par√†metres de l'URL

Cada cop que creeu una nova publicaci√≥ al vostre blog i la pengeu a les xarxes, haureu d'actualitzar l‚ÄôAPI endpoint amb el contingut nou. Tanmateix, si identifiqueu quines parts del vostre constructor `ImageResponse`¬†canviaran a cada publicaci√≥, podeu passar aquests valors com a par√†metres de l‚Äôendpoint de manera que pugueu reutilitzar-lo en totes les vostres publicacions.

En el nostre exemple, la imatge de la publicaci√≥ es crea a partir del t√≠tol i la data de publicaci√≥ de l‚Äôarticle. Passeu aquests continguts com a par√†meters.

```tsx showLineNumbers title="api/og/route.tsx" {1,5-9,23,29}
import { ImageResponse, NextRequest } from 'next/server';

export const runtime = 'edge';
 
export async function GET(req: NextRequest) {
  const { searchParams } = req.nextUrl;

  const title = searchParams.get('title');
  const publishedAt = searchParams.get('publishedAt') as string;

  return new ImageResponse(
    (
      <div
        style={{
          /* all styles again */
        }}
      >
        <div
          style={{
            /* all styles again */
          }}
        >
          <h1>{title}</h1>
          <div
            style={{
              /* all styles again */
            }}
          >
            smartido.dev ¬∑ {publishedAt}
          </div>
        </div>
      </div>
    ),
    {
      width: 1920,
      height: 1080,
    },
  );
}
```

Modifiqueu tamb√© la vostra funci√≥ `generateMetadata` per obtenir les metadates que tindran valors din√†mics.

```tsx showLineNumbers title="layout.tsx" {3-5,7,9,12,14,17}
import type { Metadata } from 'next';
 
type Props = {
  params: { id: string }
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  // read route params
  const id = params.id
  
  // fetch data
  const post = await fetch(`https://.../${id}`).then((res) => res.json())
  
  const ogImage = `https://.../api/og?title=${post.title}&publishedAt=${post.publishedAt}`;

  return {
    title: post.title,
    openGraph: {
      images: [{ url: ogImage }],
    },
  }
}
 
export default function Page({ params }) {}
```

#### Bonus ‚Äì Customitzant estils CSS

Finalment, carregueu una font dins la carpeta `/fonts` a l‚Äôarrel del vostre projecte i utilitzeu-la per crear la vostra imatge OG. Nom√©s s√≥n compatibles els formats de font `ttf`, `otf` i `woff`.

```tsx showLineNumbers title="api/og/route.tsx" {11-13,25,43-49}
import { ImageResponse, NextRequest } from 'next/server';

export const runtime = 'edge';
 
export async function GET(req: NextRequest) {
  const { searchParams } = req.nextUrl;

  const title = searchParams.get('title');
  const publishedAt = searchParams.get('publishedAt') as string;

  const fontData = await fetch(
    new URL('../../fonts/Mona-Sans.ttf', import.meta.url),
  ).then((res) => res.arrayBuffer());

  return new ImageResponse(
    (
      <div
        style={{
          /* all styles again */
        }}
      >
        <div
          style={{
            /* all styles again */
            fontFamily: 'Mona',
          }}
        >
          <h1>{title}</h1>
          <div
            style={{
              /* all styles again */
            }}
          >
            smartido.dev ¬∑ {publishedAt}
          </div>
        </div>
      </div>
    ),
    {
      width: 1920,
      height: 1080,
    },
    fonts: [
      {
        name: 'Mona',
        data: fontData,
        style: 'normal',
      },
    ],
  );
}
```

### Conclusi√≥

Es poden fer m√©s coses amb Vercel OG. Aquest tutorial nom√©s pret√©n ser un bon punt de partida per crear f√†cilment les vostres propies imatges OG que atreguin m√©s p√∫blic a veure el vostre contingut.